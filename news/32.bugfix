Properly handle malformed urls and avoid referencing unbound variables.
